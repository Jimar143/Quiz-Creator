<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generator | Jaymar Budduan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <div id="app" class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-600 mb-2">PDF Reviewer</h1>
            <p class="text-slate-500 font-medium italic">Empowering your study sessions with AI</p>
        </header>

        <!-- Main Card -->
        <div class="glass border border-slate-200 rounded-3xl shadow-xl overflow-hidden mb-6">
            <div class="p-8">
                <!-- Upload Section -->
                <div id="upload-section" class="space-y-6">
                    <div id="drop-zone" class="border-2 border-dashed border-indigo-200 rounded-2xl p-12 text-center hover:border-indigo-400 transition-colors cursor-pointer group">
                        <input type="file" id="pdf-input" class="hidden" accept="application/pdf">
                        <div class="flex flex-col items-center">
                            <i data-lucide="file-up" class="w-12 h-12 text-indigo-400 mb-4 group-hover:scale-110 transition-transform"></i>
                            <p class="text-lg font-semibold text-slate-700">Upload your PDF Reviewer</p>
                            <p class="text-sm text-slate-400 mt-1">Select or drag your file here to generate 35 items</p>
                        </div>
                    </div>
                    <div id="file-info" class="hidden flex items-center justify-between p-5 bg-indigo-50 rounded-2xl border border-indigo-100">
                        <div class="flex items-center space-x-4">
                            <div class="bg-indigo-600 p-2 rounded-lg text-white">
                                <i data-lucide="file-text" class="w-5 h-5"></i>
                            </div>
                            <span id="file-name" class="font-bold text-slate-700 truncate max-w-[200px]"></span>
                        </div>
                        <button id="generate-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg flex items-center space-x-2">
                            <span>Generate Quiz</span>
                            <i data-lucide="cpu" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading-section" class="hidden py-16 text-center">
                    <div class="relative inline-block mb-6">
                        <div class="animate-spin rounded-full h-16 w-16 border-4 border-indigo-600 border-t-transparent"></div>
                    </div>
                    <h3 id="loading-text" class="text-2xl font-bold text-slate-800">Reading PDF content...</h3>
                    <p class="text-slate-500 mt-2">The AI is carefully crafting 35 relevant questions for you.</p>
                </div>

                <!-- Quiz Display Section -->
                <div id="quiz-section" class="hidden space-y-8 animate-in fade-in duration-500">
                    <div class="flex justify-between items-center border-b border-slate-100 pb-5">
                        <div class="flex items-center space-x-3">
                            <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-black uppercase tracking-wider">
                                Question <span id="current-q-num">1</span> / 35
                            </span>
                        </div>
                        <div id="timer" class="text-slate-500 font-mono bg-slate-100 px-4 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                            <i data-lucide="timer" class="w-4 h-4"></i>
                            <span id="timer-text">00:00</span>
                        </div>
                    </div>

                    <div id="question-container" class="space-y-8">
                        <h2 id="question-text" class="text-2xl font-bold text-slate-800 leading-snug"></h2>
                        <div id="options-container" class="grid grid-cols-1 gap-4">
                            <!-- Options -->
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-8 border-t border-slate-100">
                        <button id="prev-btn" class="hidden flex items-center space-x-2 text-slate-400 hover:text-indigo-600 font-bold transition-colors">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            <span>Previous</span>
                        </button>
                        <button id="next-btn" class="ml-auto bg-slate-800 hover:bg-slate-900 text-white px-10 py-4 rounded-2xl font-black shadow-lg transition-all disabled:opacity-40 flex items-center space-x-2">
                            <span id="next-btn-text">Next Question</span>
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Result Section -->
                <div id="result-section" class="hidden">
                    <div class="text-center space-y-6 mb-12">
                        <div class="relative inline-block">
                            <svg class="w-48 h-48 transform -rotate-90">
                                <circle cx="96" cy="96" r="88" stroke="currentColor" stroke-width="12" fill="transparent" class="text-slate-100"></circle>
                                <circle id="score-circle" cx="96" cy="96" r="88" stroke="currentColor" stroke-width="12" fill="transparent" stroke-dasharray="553" stroke-dashoffset="553" class="text-indigo-600 transition-all duration-1000"></circle>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="final-score" class="text-6xl font-black text-slate-800 tracking-tighter">0</span>
                                <span class="text-slate-400 font-bold uppercase text-xs">out of 35</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <h2 id="result-title" class="text-4xl font-black text-slate-800 tracking-tight">Quiz Complete!</h2>
                            <p id="result-desc" class="text-slate-500 font-medium">Review your results below to see where you can improve.</p>
                        </div>
                        <div class="flex justify-center gap-4">
                            <button onclick="location.reload()" class="bg-slate-100 text-slate-600 px-6 py-3 rounded-xl font-bold hover:bg-slate-200 transition-all">New Quiz</button>
                            <a href="#review-list" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-md">Review Answers</a>
                        </div>
                    </div>

                    <!-- Detailed Review List -->
                    <div class="mt-12 space-y-6 pt-12 border-t border-slate-200" id="review-list">
                        <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="book-open-check" class="text-indigo-600"></i>
                            Detailed Review
                        </h3>
                        <div id="review-container" class="space-y-4">
                            <!-- Items populated via JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center py-6 text-slate-400 text-sm font-medium">
            Created by <span class="text-indigo-600 font-bold">Jaymar Budduan</span> &copy; 2025
        </footer>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-6">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl animate-in zoom-in duration-300">
            <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mb-6 mx-auto">
                <i data-lucide="shield-alert" class="text-red-600 w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-bold text-center mb-2">Something went wrong</h3>
            <p id="error-message" class="text-slate-500 text-center mb-8 leading-relaxed"></p>
            <button onclick="closeModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all shadow-lg">Back to Home</button>
        </div>
    </div>

    <script>
        // Global Constants
        const apiKey = ""; // Provided by environment
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // App State
        let questions = [];
        let userAnswers = [];
        let currentIndex = 0;
        let timerSeconds = 0;
        let timerInterval = null;

        // Element Selectors
        const pdfInput = document.getElementById('pdf-input');
        const dropZone = document.getElementById('drop-zone');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const generateBtn = document.getElementById('generate-btn');
        const uploadSection = document.getElementById('upload-section');
        const loadingSection = document.getElementById('loading-section');
        const loadingText = document.getElementById('loading-text');
        const quizSection = document.getElementById('quiz-section');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const currentQNum = document.getElementById('current-q-num');
        const nextBtn = document.getElementById('next-btn');
        const nextBtnText = document.getElementById('next-btn-text');
        const prevBtn = document.getElementById('prev-btn');
        const resultSection = document.getElementById('result-section');
        const finalScore = document.getElementById('final-score');
        const scoreCircle = document.getElementById('score-circle');
        const timerText = document.getElementById('timer-text');
        const reviewContainer = document.getElementById('review-container');

        lucide.createIcons();

        // Interactions
        dropZone.onclick = () => pdfInput.click();
        pdfInput.onchange = handleFileSelection;
        generateBtn.onclick = processPDF;

        function handleFileSelection() {
            const file = pdfInput.files[0];
            if (file && file.type === 'application/pdf') {
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');
                dropZone.classList.add('hidden');
            }
        }

        async function processPDF() {
            const file = pdfInput.files[0];
            if (!file) return;

            uploadSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');

            try {
                loadingText.textContent = "Extracting text from PDF...";
                const text = await extractTextFromPDF(file);
                
                loadingText.textContent = "AI is generating 35 English questions...";
                questions = await generateQuestions(text);
                
                if (questions.length > 0) {
                    startQuizSession();
                } else {
                    throw new Error("No questions could be generated. Try a more text-rich PDF.");
                }
            } catch (err) {
                showError(err.message);
                loadingSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let extracted = "";
            const pagesToRead = Math.min(pdf.numPages, 10); // Limit to 10 pages for stability
            
            for (let i = 1; i <= pagesToRead; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                extracted += content.items.map(item => item.str).join(" ") + " ";
            }
            return extracted.trim();
        }

        async function generateQuestions(context) {
            const systemPrompt = "You are an expert quiz master. Based on the provided text, create exactly 35 high-quality multiple-choice questions in English. Each question must have exactly 4 options (marked A, B, C, D) and specify the correct answer clearly. Output the result in a JSON array format.";
            const userPrompt = `Context text:\n${context.substring(0, 8000)}\n\nGenerate exactly 35 multiple-choice questions based on this content. Format as: [{"question": "...", "options": ["A) ...", "B) ...", "C) ...", "D) ..."], "answer": "A) ..."}]`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                question: { type: "STRING" },
                                options: { type: "ARRAY", items: { type: "STRING" }, minItems: 4, maxItems: 4 },
                                answer: { type: "STRING" }
                            },
                            required: ["question", "options", "answer"]
                        }
                    }
                }
            };

            const response = await fetchWithRetry(payload);
            return JSON.parse(response);
        }

        async function fetchWithRetry(payload, retries = 5) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error("API Failure");
                    const data = await res.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        function startQuizSession() {
            loadingSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            userAnswers = new Array(questions.length).fill(null);
            timerSeconds = 0;
            startTimer();
            renderQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timerSeconds++;
                const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
                const s = (timerSeconds % 60).toString().padStart(2, '0');
                timerText.textContent = `${m}:${s}`;
            }, 1000);
        }

        function renderQuestion() {
            const q = questions[currentIndex];
            currentQNum.textContent = currentIndex + 1;
            questionText.textContent = q.question;
            optionsContainer.innerHTML = '';

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = `group w-full text-left p-5 rounded-2xl border-2 transition-all duration-200 flex items-center justify-between ${
                    userAnswers[currentIndex] === opt 
                    ? 'border-indigo-600 bg-indigo-50 text-indigo-700 shadow-md ring-2 ring-indigo-200 ring-offset-2' 
                    : 'border-slate-100 bg-white text-slate-600 hover:border-indigo-200 hover:bg-slate-50'
                }`;
                
                btn.innerHTML = `
                    <span class="font-bold pr-4">${opt}</span>
                    <div class="w-6 h-6 rounded-full border-2 border-slate-200 flex items-center justify-center transition-all ${userAnswers[currentIndex] === opt ? 'bg-indigo-600 border-indigo-600' : ''}">
                        ${userAnswers[currentIndex] === opt ? '<i data-lucide="check" class="text-white w-4 h-4"></i>' : ''}
                    </div>
                `;
                
                btn.onclick = () => {
                    userAnswers[currentIndex] = opt;
                    renderQuestion();
                    lucide.createIcons();
                };
                optionsContainer.appendChild(btn);
            });

            nextBtnText.textContent = currentIndex === questions.length - 1 ? 'Finish Quiz' : 'Next Question';
            prevBtn.classList.toggle('hidden', currentIndex === 0);
            nextBtn.disabled = userAnswers[currentIndex] === null;
            lucide.createIcons();
        }

        nextBtn.onclick = () => {
            if (currentIndex < questions.length - 1) {
                currentIndex++;
                renderQuestion();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                calculateResults();
            }
        };

        prevBtn.onclick = () => {
            if (currentIndex > 0) {
                currentIndex--;
                renderQuestion();
            }
        };

        function calculateResults() {
            clearInterval(timerInterval);
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');

            let score = 0;
            reviewContainer.innerHTML = '';

            questions.forEach((q, i) => {
                const isCorrect = userAnswers[i] === q.answer;
                if (isCorrect) score++;

                // Build Review UI
                const reviewItem = document.createElement('div');
                reviewItem.className = `p-6 rounded-2xl border ${isCorrect ? 'border-green-100 bg-green-50/50' : 'border-red-100 bg-red-50/50'} transition-all`;
                
                reviewItem.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-8 h-8 shrink-0 rounded-lg flex items-center justify-center font-bold ${isCorrect ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">
                            ${i + 1}
                        </div>
                        <div class="flex-1 space-y-3">
                            <p class="font-bold text-slate-800 text-lg leading-tight">${q.question}</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
                                <div class="space-y-1">
                                    <span class="text-[10px] font-black uppercase text-slate-400">Your Answer</span>
                                    <p class="px-4 py-2 rounded-xl text-sm font-bold ${isCorrect ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                        ${userAnswers[i]}
                                    </p>
                                </div>
                                ${!isCorrect ? `
                                <div class="space-y-1">
                                    <span class="text-[10px] font-black uppercase text-slate-400">Correct Answer</span>
                                    <p class="px-4 py-2 rounded-xl text-sm font-bold bg-indigo-100 text-indigo-700">
                                        ${q.answer}
                                    </p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                reviewContainer.appendChild(reviewItem);
            });

            finalScore.textContent = score;
            const percentage = score / questions.length;
            scoreCircle.style.strokeDashoffset = 553 - (percentage * 553);

            const title = document.getElementById('result-title');
            if (percentage >= 0.95) title.textContent = "Outstanding!";
            else if (percentage >= 0.8) title.textContent = "Great Job!";
            else if (percentage >= 0.5) title.textContent = "Passed!";
            else title.textContent = "Keep Studying!";
        }

        function showError(msg) {
            document.getElementById('error-message').textContent = msg;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }

        function closeModal() {
            location.reload();
        }
    </script>
</body>
</html>

